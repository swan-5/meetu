<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeetU | í”„ë¼ì´ë¹— íŒ€ ë¯¸íŒ…</title>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg0: #0b0610; --pink: #ff4fd8; --rose: #ff3b8d; --text: rgba(255, 255, 255, 0.9); --border: rgba(255, 255, 255, 0.1); }
    * { box-sizing: border-box; transition: 0.3s; }
    body { margin:0; font-family: "Pretendard"; color: var(--text); background: var(--bg0); min-height: 100vh; overflow-x: hidden; }
    .container { width: min(1000px, 92vw); margin: 0 auto; }
    .topbar { position: sticky; top: 0; z-index: 100; backdrop-filter: blur(15px); background: rgba(11, 6, 16, 0.7); border-bottom: 1px solid var(--border); padding: 12px 0; }
    .topbar-inner { display: flex; align-items: center; justify-content: space-between; }
    .nav { display: flex; gap: 8px; }
    .tab { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-weight: 600; }
    .tab.active { background: linear-gradient(135deg, var(--pink), var(--rose)); border: none; }
    .section { display: none; padding: 40px 0; animation: fadeIn 0.5s ease both; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 24px; padding: 24px; backdrop-filter: blur(10px); }
    .hero-card { text-align: center; padding: 60px 40px; animation: float 4s infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    .form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
    input, textarea { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 12px; }
    .btn-primary { background: linear-gradient(135deg, var(--pink), var(--rose)); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 800; cursor: pointer; width: 100%; margin-top: 20px; }
    .chip-radio { display: none; }
    .chip-label { padding: 10px 20px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); cursor: pointer; font-size: 14px; display: inline-block; }
    .chip-radio:checked + .chip-label { background: var(--pink); border-color: var(--pink); }
    .member-card { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
  </style>
</head>
<body>
  <header class="topbar"><div class="container topbar-inner">
    <div class="brand" onclick="go('landing')" style="cursor:pointer; font-weight:800; display:flex; align-items:center;">
        <img src="logo.jpg" style="width:30px; border-radius:5px; margin-right:10px;">MeetU
    </div>
    <nav class="nav">
      <button class="tab active" data-tab="landing" onclick="go('landing')">í™ˆ</button>
      <button class="tab" data-tab="login" onclick="go('login')">ë¡œê·¸ì¸</button>
      <button class="tab" data-tab="auth" onclick="go('auth')">íšŒì›ê°€ì…</button>
      <button class="tab" data-tab="match" onclick="go('match')">ë¯¸íŒ…ë£¸</button>
      <button class="tab" data-tab="profile" onclick="go('profile')">ë§ˆì´í˜ì´ì§€</button>
    </nav>
  </div></header>

  <main class="container">
    <section id="landing" class="section active"><div class="hero-card"><h1>MeetU ğŸ’˜</h1><p>ëŒ€í•™ìƒ í”„ë¼ì´ë¹— íŒ€ ë¯¸íŒ…</p><button class="btn-primary" onclick="go('match')">ì§€ê¸ˆ ì‹œì‘í•˜ê¸° ğŸš€</button></div></section>

    <section id="login" class="section"><div class="card" style="max-width:450px; margin:0 auto;"><h2>ë¡œê·¸ì¸</h2><input id="lId" style="width:100%" placeholder="ì•„ì´ë””"><input id="lPw" type="password" style="width:100%; margin-top:10px;" placeholder="ë¹„ë°€ë²ˆí˜¸"><button class="btn-primary" onclick="handleLogin()">ë¡œê·¸ì¸</button></div></section>

    <section id="auth" class="section"><div class="card"><h2>íšŒì›ê°€ì…</h2><div class="form">
        <div style="grid-column: 1/-1;"><label>ì„±ë³„</label><br>
            <input type="radio" id="gM" name="gender" value="ë‚¨ì„±" checked class="chip-radio"><label for="gM" class="chip-label">ë‚¨ì„±</label>
            <input type="radio" id="gF" name="gender" value="ì—¬ì„±" class="chip-radio"><label for="gF" class="chip-label">ì—¬ì„±</label>
        </div>
        <input id="rId" placeholder="ì•„ì´ë””"><input id="rPw" type="password" placeholder="ë¹„ë²ˆ"><input id="rName" placeholder="ì´ë¦„">
        <input id="rUniv" placeholder="í•™êµ"><input id="rMajor" placeholder="í•™ê³¼"><input id="rAge" type="number" placeholder="ë‚˜ì´"><input id="rHeight" type="number" placeholder="í‚¤(cm)">
        <input id="studentCard" type="file" style="grid-column: 1/-1;">
    </div><button class="btn-primary" onclick="handleRegister()">ê°€ì…í•˜ê¸°</button></div></section>

    <section id="match" class="section"><div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h2>ë¯¸íŒ… ëŒ€ê¸°ì‹¤ ğŸ”¥</h2><button class="tab" onclick="createRoomPrompt()">+ ë°© ë§Œë“¤ê¸°</button></div>
        <div id="roomContainer" style="margin-top:20px; display:grid; gap:20px;"></div>
    </div></section>

   
<section id="profile" class="section">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
        <h2 style="margin:0;">ë§ˆì´í˜ì´ì§€ ğŸ’</h2>
        <button onclick="logout()" style="background:none; border:1px solid var(--pink); color:var(--pink); padding:6px 14px; border-radius:20px; font-size:12px; cursor:pointer; font-weight:700;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    
    <div class="form">
        <div class="field"><label>ë‹‰ë„¤ì„</label><input id="pNick" placeholder="ë‹‰ë„¤ì„ ì…ë ¥"></div>
        <div class="field"><label>í‚¤ (cm)</label><input id="pHeight" type="number" placeholder="180"></div>
        <div class="field"><label>ë‚˜ì˜ MBTI</label><input id="pMbti" placeholder="ENFP"></div>
        <div class="field"><label>ì´ìƒí˜•</label><input id="pIdeal" placeholder="ì›ƒëŠ” ê²Œ ì˜ˆìœ ì‚¬ëŒ"></div>
        <div class="field"><label>ì„ í˜¸ MBTI</label><input id="pPrefMbti" placeholder="Ií˜• ì„ í˜¸"></div>
        <div class="field"><label>ì„ í˜¸ ë‚˜ì´ëŒ€</label><input id="pPrefAge" placeholder="20~25ì„¸"></div>
        <div class="field" style="grid-column: 1/-1;">
            <label>ì´ê±´ ë†“ì¹˜ê¸° ì‹«ë‹¤! âœ¨</label>
            <input id="pMustHave" placeholder="ì˜ˆ: ë¹„í¡ì—°ì, ì—°ë½ ì†ë„ ë“±" style="width:100%;">
        </div>
        <div class="field" style="grid-column: 1/-1;">
            <label>ìê¸°ì†Œê°œ ë° ì·¨ë¯¸</label>
            <textarea id="pDesc" rows="3" placeholder="ë‚˜ë¥¼ í•œ ì¤„ë¡œ í‘œí˜„í•œë‹¤ë©´?" style="width:100%; font-family:inherit;"></textarea>
        </div>
    </div>
    <button class="btn-primary" onclick="handleUpdate()">ì •ë³´ ì €ì¥í•˜ê³  ë°˜ì˜í•˜ê¸° âœ¨</button>

    <div style="margin-top: 50px;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:20px;">
            <h3 style="color: var(--pink); margin:0;">ë‚˜ì˜ ë¯¸íŒ… í˜„í™© ğŸ’˜</h3>
            <span style="font-size:12px; color:var(--muted);">(ë°©ì—ì„œ ë‚˜ê°ˆ ìˆ˜ ìˆëŠ” ê¸°íšŒëŠ” ë‹¨ 2ë²ˆ!)</span>
        </div>
        <div id="myRoomList" style="display: grid; gap: 15px;">
            <p style="color:var(--muted); font-size:14px; text-align:center; padding:20px;">ì°¸ì—¬ ì¤‘ì¸ ë¯¸íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
  </div>
</section>
  </main>
<script>
    // 1. ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    let curId = null;
    let curUniv = "";
    let curMajor = "";
    let curAge = 0;
    let curGender = "";

    // 2. í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
    window.onload = function() {
        const savedUser = localStorage.getItem('meetu_user');
        if (savedUser) {
            const d = JSON.parse(savedUser);
            curId = d.user_id;
            curUniv = d.univ;
            curMajor = d.major;
            curAge = d.age;
            curGender = d.gender;
            
            // UI ë°ì´í„° ì±„ìš°ê¸°
            if(document.getElementById('pNick')) document.getElementById('pNick').value = d.nickname || "";
            
            // íŒì—… ì—†ì´ ë°”ë¡œ ë¯¸íŒ… ëª©ë¡ìœ¼ë¡œ ì´ë™
            go('match'); 
        } else {
            // ë¡œê·¸ì¸ ì •ë³´ ì—†ìœ¼ë©´ ëœë”© í˜ì´ì§€ë¡œ
            go('landing');
        }
    };

    function val(id) { return document.getElementById(id)?.value || ""; }

    // 3. ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
    function go(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const target = document.getElementById(id);
        if (target) target.classList.add('active');

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`[data-tab="${id}"]`)?.classList.add('active');
        
        // ì´ë™í•  ë•Œë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        if(id === 'match') loadRooms();
        if(id === 'profile' && curId) loadMyRooms();
    }

    // 4. ë¡œê·¸ì¸ (ì„±ê³µ ì‹œì—ë§Œ í™˜ì˜ ë©”ì‹œì§€ í•œ ë²ˆ)
    async function handleLogin() {
        try {
            const res = await fetch('/users/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login_id: val('lId'), password: val('lPw') })
            });
            const d = await res.json();
            if (res.ok) {
                if (d.is_verified !== 'verified') return alert("í•™ìƒì¦ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤! âœ¨");
                
                curId = d.user_id; curUniv = d.univ; curMajor = d.major; curGender = d.gender;
                localStorage.setItem('meetu_user', JSON.stringify(d));
                
                alert(d.nickname + "ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ’˜");
                go('match');
            } else {
                alert(d.detail || "ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            }
        } catch (e) {
            alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨!");
        }
    }

    // 5. ì „ì²´ ë¯¸íŒ… ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì¤‘ìš”!)
    async function loadRooms() {
        try {
            const res = await fetch('http://127.0.0.1:8000/rooms/');
            const rooms = await res.json();
            const container = document.getElementById('roomContainer');
            if(!container) return;

            if(rooms.length === 0) {
                container.innerHTML = `<p style="text-align:center; padding:40px; color:#888;">í˜„ì¬ ê°œì„¤ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”! ğŸš€</p>`;
                return;
            }

            container.innerHTML = rooms.map(r => `
                <div class="card" style="border: 1px solid var(--pink); margin-bottom:15px; background:rgba(255,255,255,0.02);">
                    <div style="display:flex; justify-content:space-between;">
                        <h3 style="margin:0 0 10px 0;">${r.title}</h3>
                        <span style="color:var(--pink); font-weight:bold;">${r.members.length}/${r.capacity}</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                        ${r.members.map(m => `
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                                <div style="font-size:10px; color:#aaa;">${m.univ}</div>
                                <div style="font-weight:600; font-size:14px;">${m.nickname}</div>
                                <div style="font-size:10px; color:var(--pink);">${m.gender}</div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-primary" onclick="joinRoom(${r.id})" style="margin:0;">ì°¸ì—¬í•˜ê¸° âœ¨</button>
                </div>
            `).join('');
        } catch (e) {
            console.error("ëª©ë¡ ë¡œë“œ ì—ëŸ¬:", e);
        }
    }

    // 6. ë°© ì°¸ì—¬/ìƒì„±/ì‚­ì œ ë“± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    async function joinRoom(rid) {
        if(!curId) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        const res = await fetch(`/rooms/${rid}/join?user_id=${curId}`, {method:'POST'});
        if(res.ok) { alert("ì°¸ì—¬ ì™„ë£Œ!"); go('match'); } 
        else { const d = await res.json(); alert(d.detail); }
    }
    // 1. ë‚´ ë¯¸íŒ… í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (ì™„ì „ ë³µêµ¬)
async function loadMyRooms() {
    if(!curId) return;
    
    try {
        const res = await fetch(`/users/${curId}/rooms`);
        const rooms = await res.json();
        const container = document.getElementById('myRoomList');
        
        if(!container) return;

        if(rooms.length === 0) {
            container.innerHTML = `<p style="color:var(--muted); font-size:14px; text-align:center; padding:20px;">ì°¸ì—¬ ì¤‘ì¸ ë¯¸íŒ…ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ’¨</p>`;
            return;
        }

        container.innerHTML = rooms.map(r => `
            <div class="card" style="border: 1px solid ${r.is_creator ? 'var(--pink)' : '#eee'}; background: rgba(255,255,255,0.05); position:relative; padding:20px; border-radius:15px; margin-bottom:10px;">
                ${r.is_creator ? '<span style="position:absolute; top:10px; right:15px; background:var(--pink); color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">HOST</span>' : ''}
                
                <h4 style="margin:0 0 10px 0; font-size:16px;">${r.title}</h4>
                <p style="font-size:12px; color:#aaa; margin-bottom:15px;">í˜„ì¬ ì¸ì›: ${r.current_count} / ${r.capacity}ëª…</p>
                
                <div style="display:flex; gap:8px;">
                    ${r.is_creator ? `
                        <button onclick="tossLeader(${r.id})" style="flex:1; background:#6c5ce7; color:white; border:none; padding:10px; border-radius:10px; font-size:13px; cursor:pointer; font-weight:bold;">ğŸ² ëœë¤ ë°©ì¥ í† ìŠ¤</button>
                        <button onclick="closeRoom(${r.id})" style="flex:1; background:none; border:1px solid var(--pink); color:var(--pink); padding:10px; border-radius:10px; font-size:13px; cursor:pointer; font-weight:bold;">ğŸ’¥ ë°© í­íŒŒí•˜ê¸°</button>
                    ` : `
                        <button onclick="exitRoom(${r.id})" style="width:100%; background:#555; color:white; border:none; padding:10px; border-radius:10px; font-size:13px; cursor:pointer; font-weight:bold;">ğŸ‘‹ ë°© ë‚˜ê°€ê¸° (2íšŒ ì œí•œ)</button>
                    `}
                </div>
            </div>
        `).join('');
    } catch (e) {
        console.error("ë‚´ ë¯¸íŒ… ë¡œë“œ ì—ëŸ¬:", e);
    }
}

// 2. ë°© ë‚˜ê°€ê¸° ê¸°ëŠ¥ (2íšŒ ì œí•œ ì²´í¬)
async function exitRoom(rid) {
    if(!confirm("ì •ë§ ì´ ë°©ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë‚˜ê°€ëŠ” íšŸìˆ˜ëŠ” í‰ìƒ 2íšŒë¡œ ì œí•œë©ë‹ˆë‹¤! âš ï¸)")) return;
    
    try {
        const res = await fetch(`.0.0.1:8000/rooms/${rid}/exit?user_id=${curId}`, { method: 'POST' });
        const d = await res.json();
        
        if(res.ok) {
            alert("ë°©ì—ì„œ í‡´ì¥í•˜ì˜€ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•œ ì°¸ì—¬ ë¶€íƒë“œë ¤ìš”! âœ¨");
            loadMyRooms(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            alert(d.detail); // "íšŸìˆ˜ ì´ˆê³¼" ë“±ì˜ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
        }
    } catch (e) {
        alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}

// 3. ë°© í­íŒŒ (íì‡„) ê¸°ëŠ¥
async function closeRoom(rid) {
    if(!confirm("ë°©ì„ í­íŒŒí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì°¸ì—¬ ì¤‘ì¸ ëª¨ë“  ë©¤ë²„ê°€ í©ì–´ì§‘ë‹ˆë‹¤! ğŸ’¥")) return;
    
    try {
        const res = await fetch(`/rooms/${rid}?user_id=${curId}`, { method: 'DELETE' });
        if(res.ok) {
            alert("ë°©ì´ ì„±ê³µì ìœ¼ë¡œ í­íŒŒë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadMyRooms();
        } else {
            const d = await res.json();
            alert(d.detail);
        }
    } catch (e) {
        alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨!");
    }
}

    async function createRoomPrompt() {
        const title = prompt("ì–´ë–¤ ë¯¸íŒ…ì¸ê°€ìš”? (ë°© ì œëª©)");
        const cap = prompt("ì¸ì›ìˆ˜ (2 ë˜ëŠ” 3)");
        if(!title || !cap) return;
        await fetch('/rooms/', {
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({title:title, capacity:parseInt(cap), creator_id:curId})
        });
        loadRooms();
    }

    function logout() {
        if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('meetu_user');
            location.reload();
        }
    }
    
    // ë§ˆì´í˜ì´ì§€ ë‚´ ì •ë³´ ì €ì¥
    async function handleUpdate() {
        const p = {
            user_id: curId,
            nickname: val('pNick'), university: curUniv, major: curMajor, gender: curGender,
            height: parseInt(val('pHeight')) || 0,
            mbti: val('pMbti'), ideal_type: val('pIdeal'), 
            pref_mbti: val('pPrefMbti'), pref_age: val('pPrefAge'), 
            must_have: val('pMustHave'), description: val('pDesc'), 
            meeting_type: "1:1"
        };
        const res = await fetch('/profiles/', {
            method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(p)
        });
        if(res.ok) alert("ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
    }
</script>

</body>
</html>